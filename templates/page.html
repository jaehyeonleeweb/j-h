{% extends "base.html" %}
{% block content %}

<article class="page-two-col" role="article">

  <aside class="page-meta" role="complementary">

    <div class="meta-block meta-title">
      <strong>{{ page.title }}</strong>
    </div>

    <div class="meta-block meta-data">

      {% if page.extra.doc_no %}
        <div class="meta-line">
          {% if lang == "kr" %}
            문서 번호 → [{{ page.extra.doc_no }}]
          {% else %}
            Document No. → [{{ page.extra.doc_no }}]
          {% endif %}
        </div>
      {% endif %}
    
      {% if page.extra.category %}
        <div class="meta-line">
          {% if lang == "kr" %}
            카테고리 → [{{ page.extra.category }}]
          {% else %}
            Category → [{{ page.extra.category }}]
          {% endif %}
        </div>
      {% endif %}
    
      {% if page.extra.author %}
      <div class="meta-line">
        {% if lang == "kr" %}
          저자 →
        {% else %}
          Author →
        {% endif %}
    
        {% set authors = page.extra.author %}
        {% if authors is string %}
          [{{ authors }}]
        {% else %}
          {% for item in authors %}
            [{{ item }}]{% if not loop.last %}, {% endif %}
          {% endfor %}
        {% endif %}
      </div>
    {% endif %}
    
    
    {% if page.extra.format %}
      <div class="meta-line">
        {% if lang == "kr" %}
          형식 →
        {% else %}
          Format →
        {% endif %}
    
        {% set formats = page.extra.format %}
        {% if formats is string %}
          [{{ formats }}]
        {% else %}
          {% for item in formats %}
            [{{ item }}]{% if not loop.last %}, {% endif %}
          {% endfor %}
        {% endif %}
      </div>
    {% endif %}
    
    
    {% if page.extra.print %}
      <div class="meta-line">
        {% if lang == "kr" %}
          인쇄 →
        {% else %}
          Print →
        {% endif %}
    
        {% set prints = page.extra.print %}
        {% if prints is string %}
          [{{ prints }}]
        {% else %}
          {% for item in prints %}
            [{{ item }}]{% if not loop.last %}, {% endif %}
          {% endfor %}
        {% endif %}
      </div>
    {% endif %}
    
    
    {% if page.extra.date_ym %}
      <div class="meta-line">
        {% if lang == "kr" %}
          날짜 →
        {% else %}
          Date →
        {% endif %}
    
        {% set dates = page.extra.date_ym %}
        {% if dates is string %}
          [{{ dates }}]
        {% else %}
          {% for item in dates %}
            [{{ item }}]{% if not loop.last %}, {% endif %}
          {% endfor %}
        {% endif %}
      </div>
    {% endif %}

      {% if page.extra.link %}
      {% set is_method =
        page.extra.category == "Method"
        or page.extra.category == "방법"
      %}
    
      <div class="meta-line">
        {% if is_method %}
          {% if lang == "kr" %}
            이 방법이 사용된 작업 →
          {% else %}
            Work using this method →
          {% endif %}
        {% else %}
          {% if lang == "kr" %}
            관련한 문서 →
          {% else %}
            Related documents →
          {% endif %}
        {% endif %}
    
        {% for item in page.extra.link %}
          {% if item.href %}
            [<a href="{{ item.href }}">{% if item.label %}{{ item.label }}{% else %}link{% endif %}</a>]{% if not loop.last %}, {% endif %}
          {% endif %}
        {% endfor %}
      </div>
    {% endif %}
  
  
    
    </div>
    

    {% if page.extra.meta_description %}
    <div class="meta-block meta-desc">
      {% for line in page.extra.meta_description %}
        <div class="meta-line">
          → {{ line | markdown(inline=true) | safe }}
        </div>
      {% endfor %}
    </div>
    {% endif %}
    

    {% if page.extra.notes %}
    <div class="meta-block meta-notes">
      {% for note in page.extra.notes %}
        <div
          class="meta-line meta-note"
          data-fnid="fn-{{ note.id }}"
          role="link"
          tabindex="0"
        >
          <span class="footnote-num">{{ note.id }}</span>
          <span class="footnote-arrow"> → </span>
          <span class="footnote-text">
            {{ note.text | markdown(inline=true) | safe }}
          </span>
        </div>
      {% endfor %}
    </div>
    {% endif %}
    

  </aside>

  <div class="page-body page-content">

    {{ page.content | safe }}

  </div>

</article>

<div id="image-viewer" aria-hidden="true">
  <button class="viewer-close" aria-label="Close">×</button>
  <button class="viewer-prev" aria-label="Previous">←</button>
  <img class="viewer-image" alt="" />
  <button class="viewer-next" aria-label="Next">→</button>
</div>

<div id="link-preview" aria-hidden="true"></div>


<script>
  (function () {
  
    function isVisible(el) {
      return !!(el && el.offsetParent !== null);
    }
  
    function isInViewport(el) {
      if (!el) return false;
      const r = el.getBoundingClientRect();
      return r.bottom > 0 && r.top < window.innerHeight;
    }
  
    function scrollToRef(el, block) {
      if (!el) return;
      el.scrollIntoView({
        behavior: "smooth",
        block: block
      });
    }
  
    function scrollDocumentToRevealMeta() {
      window.scrollTo({
        top: document.documentElement.scrollHeight,
        behavior: "smooth"
      });
    }
  
    function setActiveFootnote(id) {
      history.pushState(null, "", "#" + id);
  
      document.querySelectorAll(".meta-note").forEach(el => {
        el.classList.toggle("is-active", el.dataset.fnid === id);
      });
  
      document.querySelectorAll(".footnotes-list li[id]").forEach(el => {
        el.classList.toggle("is-active", el.id === id);
      });
    }
  
    const mqDesktop = window.matchMedia("(min-width: 600px)");
  
    document.addEventListener("click", function (e) {
  
      const meta = e.target.closest(".meta-note[data-fnid]");
      if (meta) {
        if (e.target.closest("a")) return;
  
        const id = meta.dataset.fnid;
        if (!id) return;
  
        const ref = document.querySelector(
          '.footnote-reference a[href="#' + id + '"]'
        );
        if (!ref) return;
  
        scrollToRef(ref, "start");
        setActiveFootnote(id);
        return;
      }
  
      const def = e.target.closest(".footnotes-list li[id]");
      if (def) {
        if (e.target.closest("a")) return;
  
        const id = def.id;
        if (!id) return;
  
        const ref = document.querySelector(
          '.footnote-reference a[href="#' + id + '"]'
        );
        if (!ref) return;
  
        scrollToRef(ref, "start");
        setActiveFootnote(id);
        return;
      }
  
      const refLink = e.target.closest(".footnote-reference a[href^='#']");
      if (!refLink) return;
  
      e.preventDefault();
  
      const id = refLink.getAttribute("href").slice(1);
      if (!id) return;
  
      setActiveFootnote(id);
  
      if (mqDesktop.matches) {
        const metaTarget = document.querySelector(
          ".meta-note[data-fnid='" + id + "']"
        );
  
        if (metaTarget && isVisible(metaTarget)) {
          if (!isInViewport(metaTarget)) {
            scrollDocumentToRevealMeta(metaTarget);
          }
          return;
        }
      }
  
      const footTarget = document.getElementById(id);
      if (footTarget && isVisible(footTarget)) {
        scrollToRef(footTarget, "end");
      }
    });
  
    document.addEventListener("DOMContentLoaded", function () {
      if (!location.hash.startsWith("#")) return;
  
      const id = location.hash.slice(1);
      if (!id) return;
  
      setActiveFootnote(id);
  
      if (mqDesktop.matches) {
        const metaTarget = document.querySelector(
          ".meta-note[data-fnid='" + id + "']"
        );
        if (metaTarget && isVisible(metaTarget)) {
          if (!isInViewport(metaTarget)) {
            scrollDocumentToRevealMeta(metaTarget);
          }
          return;
        }
      }
  
      const footTarget = document.getElementById(id);
      if (footTarget && isVisible(footTarget)) {
        scrollToRef(footTarget, "end");
      }
    });
  
  })();
  </script>  
  
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const PUNCTS = `"'\u2018\u201C([{‹«〈《「『`;
    
        const targets = document.querySelectorAll(
  '.page-meta .meta-title, \
   .page-meta .meta-line, \
   .page-body .page-content p, \
   .page-body .page-content li'
);

    
      targets.forEach(el => {
        const text = (el.textContent || '').trimStart();
        if (!text) return;
    
        const firstChar = text[0];
        if (!PUNCTS.includes(firstChar)) return;
    
        el.classList.add('hang-punct');
      });
    });
    </script>
    
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const superscriptMap = {
          "0": "⁰",
          "1": "¹",
          "2": "²",
          "3": "³",
          "4": "⁴",
          "5": "⁵",
          "6": "⁶",
          "7": "⁷",
          "8": "⁸",
          "9": "⁹"
        };
      
        document
          .querySelectorAll("sup.footnote-reference a")
          .forEach(el => {
            const text = el.textContent.trim();
      
            if (!/^\d+$/.test(text)) return;
      
            const superscript = [...text]
              .map(d => superscriptMap[d] || d)
              .join("");
      
            el.textContent = superscript;
            el.setAttribute("aria-label", `Footnote ${text}`);
          });
      });
      </script>
      
      <script>
        (function () {
          const root = document.querySelector(".page-body.page-content");
          if (!root) return;

          root.querySelectorAll("blockquote ol > li").forEach(li => {
            if (li.querySelector(":scope > .li-body")) return;

            const body = document.createElement("span");
            body.className = "li-body";

            const nodes = Array.from(li.childNodes);

            nodes.forEach(node => {
              if (
                node.nodeType === Node.ELEMENT_NODE ||
                (node.nodeType === Node.TEXT_NODE && node.textContent.trim() !== "")
              ) {
                body.appendChild(node);
              }
            });

            li.appendChild(body);
          });
        })();
        </script>


        <script>
          document.addEventListener("DOMContentLoaded", () => {
            const root = document.querySelector(".page-body.page-content");
            if (!root) return;
          
            root.querySelectorAll("p > strong").forEach(strong => {
              const parent = strong.parentElement;
              if (parent && parent.classList.contains("centered-strong")) return;
          
              const wrapper = document.createElement("span");
              wrapper.className = "centered-strong";
          
              parent.replaceChild(wrapper, strong);
              wrapper.appendChild(strong);
            });
          });
          </script>
  
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const isMobile = window.matchMedia("(max-width: 600px)").matches;
    
      const images = Array.from(
        document.querySelectorAll(".page-body.page-content figure img")
      );
      if (!images.length) return;
    
      const viewer = document.getElementById("image-viewer");
      const viewerImg = viewer.querySelector(".viewer-image");
      const btnClose = viewer.querySelector(".viewer-close");
      const btnPrev = viewer.querySelector(".viewer-prev");
      const btnNext = viewer.querySelector(".viewer-next");
    
      let currentIndex = 0;
      let scrollY = 0;
    
      function lockScroll() {
        scrollY = window.scrollY;
        document.body.style.position = "fixed";
        document.body.style.top = `-${scrollY}px`;
        document.body.style.left = "0";
        document.body.style.right = "0";
        document.body.style.width = "100%";
      }
    
      function unlockScroll() {
        document.body.style.position = "";
        document.body.style.top = "";
        document.body.style.left = "";
        document.body.style.right = "";
        document.body.style.width = "";
        window.scrollTo(0, scrollY);
      }
    
      function openViewer(index) {
        currentIndex = index;
        viewerImg.src = images[currentIndex].src;
        viewer.classList.add("is-open");
        viewer.setAttribute("aria-hidden", "false");
    
        if (isMobile) lockScroll();
      }
    
      function closeViewer() {
        viewer.classList.remove("is-open");
        viewer.setAttribute("aria-hidden", "true");
    
        if (isMobile) unlockScroll();
      }
    
      function prev() {
        if (currentIndex > 0) openViewer(currentIndex - 1);
      }
    
      function next() {
        if (currentIndex < images.length - 1) openViewer(currentIndex + 1);
      }
    
      images.forEach((img, i) => {
        img.style.cursor = "zoom-in";
        img.addEventListener("click", () => openViewer(i));
      });
    

      if (!isMobile) {
        btnClose.addEventListener("click", closeViewer);
        btnPrev.addEventListener("click", prev);
        btnNext.addEventListener("click", next);
    
        viewerImg.addEventListener("click", closeViewer);
        viewer.addEventListener("click", e => {
          if (e.target === viewer) closeViewer();
        });
      }
    
      if (isMobile) {
        viewer.addEventListener("click", closeViewer);
    
        let startX = 0;
        let startY = 0;
    
        viewer.addEventListener(
          "touchstart",
          e => {
            const t = e.touches[0];
            startX = t.clientX;
            startY = t.clientY;
          },
          { passive: true }
        );
    
        viewer.addEventListener("touchend", e => {
          const t = e.changedTouches[0];
          const dx = t.clientX - startX;
          const dy = t.clientY - startY;
    
          if (Math.abs(dx) > 40 && Math.abs(dx) > Math.abs(dy)) {
            dx > 0 ? prev() : next();
          }
        });
      }
    
      document.addEventListener("keydown", e => {
        if (!viewer.classList.contains("is-open")) return;
    
        if (e.key === "Escape") closeViewer();
        if (e.key === "ArrowLeft") prev();
        if (e.key === "ArrowRight") next();
      });
    });
    </script>
    

<script>
  (function () {
    if (!window.matchMedia("(min-width: 601px)").matches) return;
  
    const preview = document.createElement("div");
    preview.id = "link-preview";
    document.body.appendChild(preview);
  
    let aborter = null;
  
    function isInternalLink(a) {
      if (!a || !a.href) return false;
      try {
        return new URL(a.href).origin === location.origin;
      } catch {
        return false;
      }
    }
  
    function extractPreviewText(html) {
        const doc = new DOMParser().parseFromString(html, "text/html");

        const body = doc.querySelector(".page-body");
        if (!body) return "";

        body.querySelectorAll(
          "figure, img, pre, code, table, script, style, \
          .footnotes, .footnotes-list, aside"
        ).forEach(el => el.remove());

        body.querySelectorAll("sup").forEach(el => el.remove());

        const candidates = Array.from(
          body.querySelectorAll("p, li")
        )
          .map(el =>
            el.textContent
              .replace(/\s+/g, " ")
              .trim()
          )
          .filter(text => text.length > 0);

        if (!candidates.length) return "";

        return candidates[0];
      }
  
    function positionPreview(e) {
      const offset = 14;
      const maxX = window.innerWidth  - preview.offsetWidth  - 8;
      const maxY = window.innerHeight - preview.offsetHeight - 8;
  
      preview.style.left = Math.min(e.clientX + offset, maxX) + "px";
      preview.style.top  = Math.min(e.clientY + offset, maxY) + "px";
    }
  
    document.addEventListener("mouseover", async (e) => {
      const a = e.target.closest("a[href]");
      if (!a || !isInternalLink(a)) return;
      
      if (a.closest("sup")) return;
      
      aborter?.abort();
      aborter = new AbortController();
  
      try {
        const res = await fetch(a.href, { signal: aborter.signal });
        const html = await res.text();
        const text = extractPreviewText(html);
  
        if (!text) return;
  
        preview.textContent = text;
        preview.classList.add("is-visible");
        positionPreview(e);
      } catch {
      }
    });
  
    document.addEventListener("mousemove", (e) => {
      if (!preview.classList.contains("is-visible")) return;
      positionPreview(e);
    });
  
    document.addEventListener("mouseout", (e) => {
      if (!e.target.closest("a[href]")) return;
      preview.classList.remove("is-visible");
      aborter?.abort();
    });
  })();
  </script>
  
  
    


{% endblock content %}
