{% extends "base.html" %}
{% block content %}


<article class="page-two-col">
  
  <aside class="page-meta">
    <dl class="meta-list">
      {% if page.extra.doc_no %}
        <dt><h1>document no.:</h1></dt>
        <dd>{{ page.extra.doc_no }}</dd>
      {% endif %}
  
      {% if page.extra.category %}
        <dt><h1>category:</h1></dt>
        <dd>{{ page.extra.category }}</dd>
      {% endif %}
  
      {% if page.extra.date_ym %}
        <dt><h1>date:</h1></dt>
        <dd>{{ page.extra.date_ym }}</dd>
      {% endif %}
  
      {% if page.extra.format %}
        <dt><h1>format:</h1></dt>
        <dd>{{ page.extra.format }}</dd>
      {% endif %}
  
      {% if page.extra.link %}
      <dt><h1>link:</h1></dt>
      <dd class="meta-link">
        <a href="{{ page.extra.link }}">
          {{ page.extra.link_label | default(value=page.extra.link) }}
        </a>
      </dd>
      {% endif %}
  
      {% if page.extra.author %}
        <dt><h1>author:</h1></dt>
        <dd>{{ page.extra.author }}</dd>
      {% endif %}

      {% if page.extra.print %}
        <dt><h1>print:</h1></dt>
        <dd>{{ page.extra.print }}</dd>
      {% endif %}

    </dl>
  </aside>

  <div class="page-body page-content">
    {% set display_title_src = page.extra.display_title | default(value=page.title) %}
    <h1 class="display-title">
      {{ display_title_src | markdown(inline=true) | safe }}
    </h1>
    {{ page.content | safe }}

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const content = document.querySelector('.page-content');
        if (!content) return;
      
        /* ---------------------------------------------
         * 1) 흩어진 각주 아이템을 .footnotes 컨테이너로 래핑
         *    - 대상: .footnote-definition, li[id^="fn"]
         *    - 이미 .footnotes가 있으면 건너뜀
         * --------------------------------------------- */
        let wrap = content.querySelector('.footnotes');
        if (!wrap) {
          const items = Array.from(
            content.querySelectorAll('.footnote-definition, li[id^="fn"]')
          );
          if (items.length) {
            const parent = items[0].parentElement;
            const group = items.filter(el => el.parentElement === parent);
            if (group.length) {
              wrap = document.createElement('div');
              wrap.className = 'footnotes';
              wrap.setAttribute('role', 'doc-endnotes');
              wrap.setAttribute('aria-label', 'Footnotes');
              parent.insertBefore(wrap, group[0]);
              group.forEach(el => wrap.appendChild(el));
            }
          }
        }
      
        /* ---------------------------------------------
         * 2) 각주 본문(p) 내 URL을 <a>로 자동 변환
         *    - 호환: http/https/www
         *    - 말미의 쉼표/마침표/괄호 등은 제외
         * --------------------------------------------- */
        if (wrap) {
          const URL_RE = /((?:https?:\/\/|www\.)[^\s<>()]+?)(?=[\s<>()]|$)/g;
      
          wrap.querySelectorAll('.footnote-definition > p, li[id^="fn"] > p')
            .forEach(p => {
              if (p.dataset.autolinked === '1') return;
              p.innerHTML = p.innerHTML.replace(URL_RE, (m, url) => {
                const href = url.startsWith('http') ? url : `https://${url}`;
                return `<a href="${href}" target="_blank" rel="noopener noreferrer">${url}</a>`;
              });
              p.dataset.autolinked = '1';
            });
      
          // 안전: 링크 rel 보정
          wrap.querySelectorAll('a').forEach(a => {
            const rel = (a.getAttribute('rel') || '').split(/\s+/);
            ['noopener','noreferrer'].forEach(tok => { if (!rel.includes(tok)) rel.push(tok); });
            a.setAttribute('rel', rel.join(' ').trim());
          });
        }
      });
      </script>
      
  </div>

</article>

{% endblock content %}
